TODO
- [ ] Heidi will do the rotation alignment
- [ ] Heidi will look at the landing posts at room temperature and see about the eucentric height
- [ ] Gen will try and figure out ion-SEM alignment for j-cut
- [ ] Gen will also work more on the needle identification

Plan for next FIBSEM session
- [ ] Landing post eucentric height check
- [ ] Do more liftouts


PROBLEM:
Heidi wants to move the needle in this order:
* y movement (electron beam image)
* z movement  (ion beam image)
* x movement (electron beam image)
Otherwise it's too risky that we'll hit something (this has happened to us)


Cutting the needle off, milling pattern
* 5 microns width
* 1 micron height
* 3 micron milling depth
* 30 degree rotation
* milling current = 0.2 nano-Amps

milling pattern to glue the lamella to the landing post
* 3 microns width
* 5 microns height
* 5 nano-meters milling depth
* milling current = imaging current, 20 pico-Amps

magnification for liftout
* trench view is 82.29e-6 horizontal_field_width for both electron & ion beams

magnification for landing posts
* when you insert the needle for LANDING, use 0.000500 horizontal_field_width

Landing post stage tip from Alex
--------------------------------
We should mount the landing post grid upside down, so the flatter part is the
bit that we see. Then it's easier to focus on the flat surface.

Alex says:
Try autofocus at low magnification flat to SEM
Zoom in on the post
Do the autofocus again (on the edge of the post)

Ion-SEM alignment
Alex says:
* Brute force alignment search, which method works best
* edge filters before alignment, does this help
* Write stuff to accomodate scaling between ion & SEM images
* Make a function to plot where the alignment thinks it should go

If you have mismatched image pixel sizes, pad the smaller one with the mean value,


Returning to the landing post position
--------------------------------------
Must keep track of the horizontal_field_width for the landing post images (EB & IB)

Must do stage movements in order:
* first tilt back to zero,
* then rotate to where you want to go
* then move x/y/z to where you want to go
* then tilt to where you want to go
To align the posts, we want the horizontal_field_width = 0.0002072 meters
* microscope.beams.electron_beam.horizontal_field_width.value = 0.0002072
* microscope.beams.ion_beam.horizontal_field_width.value = 0.0002072
Realign posts at this high magnification, then zoom out the magnification of the ion beam
* microscope.beams.electron_beam.horizontal_field_width.value = 0.0002072
* microscope.beams.ion_beam.horizontal_field_width.value = 0.000319  # THIS HAS CHANGED!


How much to mill a flat edge on the landing posts
-------------------------------------------------
width = 5 microns
height = 12 microns
z_milling_depth = 5 microns (this is probably overkill)
ion_beam_current = 28 nano-Amps


Heidi eucentricity calibration on the sample
---------------------------------------------
Stage is already focused/linked for electron beam
Center SEM image, full grid view
Zoom in on SEM image - microscope.beams.electron_beam.horizontal_field_width.value = 0.000104
Make a reduced area in the top left corner of the SEM, focus, relink stage (z=3.95 or 3.98mm)
Zoom in on SEM image AGAIN - microscope.beams.electron_beam.horizontal_field_width.value = 0.000592
Double click SEM image to center the feature of interest you will use to do the eucentric height adjustment
Take another SEM image (with the same magnification) now the feature is centered
(Heidi tends to zoom in to 259um in SEM just to check the centering has worked well & she doesn't need to adjust it again)
Zoom in on ion beam image - microscope.beams.ion_beam.horizontal_field_width.value = 0.000259 # 0.0004144
Take new ion beam image
User selects the same feature in the ion beam image.


Differences when we get to the landing grid:
* No inserting the multichem
* When we move the needle, first move z with ion beam view, then move x & y
* No safety buffer in z (or y or x) when you stick the landing
* The curve of the landing posts is annoying, we can get around that by
milling a flat edge on the landing post when we set up the position.


MOVING THE STAGE OUT OF THE WAY SO WE CAN SEE THE NEEDLE WITH NO BACKGROUND
In [6]: microscope = initialize()
Client connecting to [10.0.0.1:7520]...
Client connected to [10.0.0.1:7520]

In [7]: stage_down_position = microscope.specimen.stage.current_position

In [8]: stage_down_position
Out[8]: StagePosition(x=0.0012380833,y=0.016882333,z=0.0039667293,t=-5.0732825e-
06,r=5.0615304)

Needle image from 19th November 2020 are copied to:
Y:\ADM-LAB\Genevieve\Projects\liftout\data\Auto_lamella_cryo_8_with alex\

AUTO-FOCUS SEEMS TO RUN FOREVER
Here's a traceback message, but we think this happened because Alex or Heidi

In [58]: left, top, width, height = (0, 0, 1, 1)

In [59]: reduced_area = Rectangle(left, top, width, height)

In [60]:     focus_settings = RunAutoFocusSettings(
    ...:         method="Volumescope",
    ...:         resolution="1536x1024",
    ...:         reduced_area=reduced_area,
    ...:         number_of_frames=1,
    ...:         working_distance_step=1e-6,
    ...:         line_integration=1,
    ...:         dwell_time=500e-9,
    ...:     )

In [65]: microscope.auto_functions.run_auto_focus(focus_settings)
---------------------------------------------------------------------------
ApplicationServerException                Traceback (most recent call last)
<ipython-input-65-286cebb1814d> in <module>
----> 1 microscope.auto_functions.run_auto_focus(focus_settings)

c:\users\admin\anaconda3\envs\fibsem\lib\site-packages\autoscript_sdb_microscope
_client\sdb_microscope\_auto_functions.py in run_auto_focus(self, settings)
     76             call_request.parameters.data_types = [DataTypeDefinition(Dat
aType.STRUCTURE_PRIMARY_ID, secondary_id="RunAutoFocusSettings")]
     77             call_request.parameters.values = [settings]
---> 78             call_response = self.__application_client._perform_call(call
_request)
     79         else:
     80             raise Exception("Cannot execute method with the given parame
ters combination. Read the documentation for details of how to call this method.
")

c:\users\admin\anaconda3\envs\fibsem\lib\site-packages\autoscript_sdb_microscope
_client\sdb_microscope_client.py in _perform_call(self, call_request)
    164
    165         try:
--> 166             call_response = self.__endpoint.perform_call(call_request)
    167         except ApiException as api_exception:
    168             ApplicationClientLoggingHelper.log_call_error(call_request.w
ide_call_id, api_exception)

c:\users\admin\anaconda3\envs\fibsem\lib\site-packages\autoscript_core\orc\engin
es.py in perform_call(self, call_request)
    190
    191                         Logging.loggers[LogDomain.ORC].log_call_error(ca
ll_request.wide_call_id, CommunicationSide.CLIENT, api_exception)
--> 192                         raise api_exception
    193
    194                     Logging.loggers[LogDomain.ORC].log_call_notification
(call_request.wide_call_id, CallOperationCode.LEAVE, CommunicationSide.CLIENT, "
Call left client ORC")

ApplicationServerException: An unexpected error occurred in the application serv
er.
Focus cycling error

In [66]:
